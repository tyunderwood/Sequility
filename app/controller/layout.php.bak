<?php
/**
***************************************************************************************************
 * @Software    AjaxMint Gallery
 * @Author      Rajapandian - arajapandi@gmail.com
 * @Copyright   Copyright (c) 2010-2011. All Rights Reserved.
 * @License     GNU GENERAL PUBLIC LICENSE
 **************************************************************************************************
 This source code is licensed under the terms of the GNU GENERAL PUBLIC LICENSE
 http://www.gnu.org/licenses/gpl.html
 **************************************************************************************************
 Copyright (c) 2010-2011 http://ajaxmint.com. All Rights Reserved.
 **************************************************************************************************
**/

class ControllerLayout extends Controller {
    protected function index() {
  
        $this->db = Registry::get('db');
 
        $this->table = DB_PREFIX.'user';
        $this->load->model('users');
      
        $this->session = Registry::get('session');
        if (isset($this->session->data['user_id']) && $this->session->data['user_id']) {
            $nickname = $this->user->getNickName();
            $this->data['settings'] = "Account Settings: $nickname";
          
            // twitter
            $twitter_token = $this->user->getTwitterToken();
 echo $twitter_token; exit;
            if ($twitter_token == '') {
            
                // getting back the merchant's screen name if app registration worked
                // meaning... api works, merchnat approved app
                
                $twitter_token = $this->process_twitter_registration();
          
                unset($this->session->data['access_token']);
                 
                }  
        
            $this->session->data['twitter_token'] = $twitter_token;
 
            } else {
            $this->data['settings'] = 'Register';
            }
     
        $search_level = 0;
        $cat_id = 0; 
        $mode = 'cats';
   
        if (isset($this->request->get['search_level']) && is_numeric($this->request->get['search_level'])) {
            $search_level = $this->request->get['search_level'];
            } else {
            $search_level = 0;
            }  
// print_array($_REQUEST); exit;  
        $this->data['var_search_level'] = "var search_level=$search_level; \n";   // define a js variable

        if (isset($this->request->get['cat_id']) && is_numeric($this->request->get['cat_id'])) {
            $cat_id = $this->request->get['cat_id'];
            } else {
            $cat_id = 0;
            } 
 
        $this->data['var_cat_id'] = "var cat_id=$cat_id; \n";   // define a js variable

        if (isset($this->request->get['mode'])) {
            $mode = $this->request->get['mode'];
            } else {
            $mode = 'cats';
            } 
 
        $this->data['var_mode'] = "var mode='$mode'; \n";   // define a js variable
 
        if (isset($this->request->get['zip'])) {
            $zip = $this->request->get['zip'];
            } else {
            $zip = '';
            } 
 
        $this->data['var_zip'] = "var zip='$zip'; \n";   // define a js variable

 
        if (isset($this->request->get['picture_id'])) {
            $picture_id = $this->request->get['picture_id'];
            } else {
            $picture_id = $this->data['picture_id'];
            } 
 
        $this->data['var_picture_id'] = "var picture_id='$picture_id'; \n";   // define a js variable
        
        if (isset($this->request->get['pledge_id'])) {
            $pledge_id = $this->request->get['pledge_id'];
            } else {
            $pledge_id = 0;
            } 
  
        if (isset($this->request->get['origin']) &&
            $this->request->get['origin'] == 'actives') {
            $origin = $this->request->get['origin'];
            $pledge_id = 0;
//print_array($this->request->get); exit;              
            if (isset($this->request->get['pledge_id']) &&
                isset($this->request->get['rid'])) {
                // /create or add pledge 
                $this->createPledge($this->request->get['pledge_id']);
                $pledge_id = 0;               
  
                }
                
            $this->data['var_pledge_id'] = "var pledge_id='$pledge_id'; \n";   // define a js variable
            
            } else {
            $origin = 'catalog';
            $this->data['var_pledge_id'] = "var pledge_id='0'; \n";   // define a js variable

            }
        
        $user_id = $this->session->data['user_id'];
        if (isset($this->session->data['user_id']) && $this->session->data['user_id'] != 0) {
            $this->data['var_user_id'] = "var logged_user_id='$user_id'; \n";   // define a js variable
            } else {
            $this->data['var_user_id'] = "var logged_user_id='0'; \n";   // define a js variable
            }

        $manager_store_id = $this->session->data['manager_store_id'];
        if (isset($this->session->data['manager_store_id']) && $this->session->data['manager_store_id'] != 0) {
            $this->data['var_manager_store_id'] = "var manager_store_id='$manager_store_id'; \n";   // define a js variable
            } else {
            $this->data['var_manager_store_id'] = "var manager_store_id='0'; \n";   // define a js variable
            }
                        
        $this->data['var_origin'] = "var origin='$origin'; \n";   // define a js variable
          
        $this->data['title'] = $this->config->get('config_site_title');
        $this->data['description'] = $this->config->get('config_site_description');
        $this->data['template'] = HTTP_SERVER."/app/view/".$this->config->get('config_template');                
        $this->data['logo'] = $this->config->get('config_logo');
        $this->data['icon'] = $this->config->get('config_icon');
 
 	    // here we shl have something like: $this->data['label']['pledges'] = fx('pledges')
 	    // which will call $this->config->get('locale') to get the label in the language
 	    $this->data['label']['pledges'] = "Pledges";
          
        $this->template = $this->config->get('config_template') . 'layout.php';                
        $this->render();
    }
 
    private function createPledge($pledge_id) {
    
        $rid = $this->request->get['rid'];  // products_details id
        
        $this->load->model('pledges');  
        $this->load->model('products');   
 
        $store_data = $this->model_products->getStore($rid);   
        $store_id = $store_data['store_id'];
        $attributes = $store_data['attributes']; 
         
        $detail_uid = $store_data['detail_uid'];   
        
        /*
        save our pledge and provide client all that's needed to get
        the active pledges to show in the active carousel
        */     
              
        $pledge = array();
        $pledge['rid'] = $rid;  // will get the store_id with it
        $pledge['reference'] = $this->request->get['reference'];
        $pledge['attributes'] = $attributes; 
        $pledge['detail_uid'] = $detail_uid; 
        
        $pledge['maxprice'] = $this->request->get['maxprice'];
        $pledge['expdate'] = $this->request->get['expdate'];
        $pledge['user_id'] = $this->session->data['user_id'];
        $pledge['store_price'] = $this->request->get['store_price'];
        
        $pledge['store_id'] = $store_id;
        $pledge['pledge_id'] = $pledge_id;  // zero when creation
        
        $pledge_id = $this->model_pledges->savePledge($pledge);   
        
        // check if store manager has a twitter account and send msg
        $storeData = $this->model_products->getStoreManager($store_id);
        
        if ( is_array($storeData) ) {
            if ($storeData['twitter_access_token'] != '') {
            
                $user_id = $storeData['user_id'];
                $tokens = unserialize($storeData['twitter_access_token']);
//print_array($tokens);               
                $accessToken = $tokens['oauth_token'];
                $accessTokenSecret = $tokens['oauth_token_secret'];
                
                $consumer_key = $this->config->get('consumer_key');
                $consumer_secret = $this->config->get('consumer_secret'); 
//echo "$user_id,$consumer_key, $consumer_secret, $accessToken, $accessTokenSecret"; exit;               
                $twitter = new Tweet(0,$consumer_key, $consumer_secret,$accessToken,$accessTokenSecret);             
                if ($twitter == null) return false;
               
                $twitter->tweet("hello world IV $pledge_id " );
                }
            } 
    
    }
    
    
    function process_twitter_registration() {
       
        if (! isset($this->request->get['twitter_reg']) || 
            $this->session->data['user_id'] == 0) return null;
        
        if ($this->session->data['manager_store_id'] == 0) {
            return null;
            }
 
        $consumer_key = $this->config->get('consumer_key');
        $consumer_secret = $this->config->get('consumer_secret'); 
        $user_id = $this->session->data['user_id'];

        if ($this->request->get['twitter_reg'] == 'step_1') {
            $twitter = new Tweet($user_id,$consumer_key, $consumer_secret);  
            return null; 
            }
       
        if ($this->request->get['twitter_reg'] == 'step_2' && 
            isset($this->request->get['user_id']) &&
            $this->request->get['user_id'] != 0) {
            
            $user_id = $this->request->get['user_id'];
     
            $accessToken = $this->session->data['oauth_token'];
            $accessTokenSecret = $this->session->data['oauth_token_secret'];
            
            // do NOT forget this step!!!!
            $twitter = new Tweet($user_id,$consumer_key, $consumer_secret,$accessToken,$accessTokenSecret); 

            // this merchant is now signed in... but he is not the one which is going
            // to post messages... visitors are :)
            // so we don't need to save $twitter now.. we will get the credentials
            // when a visitor gets into a store and pledge
             
            // save those under user_id: $this->session['access_token'] 
            if (! isset($this->session->data['access_token']['screen_name'])) return null;
            
            $access_token = serialize($this->session->data['access_token']);
            
            $this->model_users->setTwitterToken($user_id,$access_token);    
            
            return $access_token;
          
            }
     
        return null;
    }
    
}