<?php 
/**
***************************************************************************************************
 * @Software    Pin2Shop
 * @Author      Michel Kohon - michelk18@gmail.com
 * @Copyright   Copyright (c) 2012-. All Rights Reserved.
 * @License     GNU GENERAL PUBLIC LICENSE
 **************************************************************************************************
 This source code is licensed under the terms of the GNU GENERAL PUBLIC LICENSE
 http://www.gnu.org/licenses/gpl.html
 **************************************************************************************************
 Copyright (c) 2010-2011 http://emediaboard.com. All Rights Reserved.
 **************************************************************************************************
**/
 
class ControllerMysettings extends Controller {
 
    function __construct() {
 
        $this->db = Registry::get('db');
        $this->id = 'content';
         
        $this->load->model('users');
        $this->load->model('pledges');
        $this->layout   = 'layout';
        $this->config = Registry::get('config'); 
 
    }    
       
    function index() {
 
        if (isset($this->session->data['user_id']) && 
            $this->session->data['user_id']) {
            $this->showAccount();
            } else {
            echo json_encode(array(  
                'result'=>'ok',           
                'user_id'=>0 
                ));          
            exit;            
            }
 
    }
 
    function showAccount() {
           
        $user_id = $this->session->data['user_id']; 
        $nickname = $this->user->getNickName();
                
        $coupons = "Pledge ID# |Shop |Accepted Px |Status|Created |Expiration| Redeem| Action \n"; 
        $range = array('paid-coupon','paid');  
        $image = 'print.png';  
        $action_link = HTTP_SERVER."/app/view/".$this->config->get('config_template')."/images/print.png";
        $coupons .= $this->getPledges(1,$user_id,$range,$image,$action_link);

        $pledges = "Pledge ID# |Shop |Bid |Offered |Status|Created |Expiration| Action \n"; 
        $range = array('open');
        $image = 'btn_proceed_to_checkout.gif';
        $action_link = HTTP_SERVER."/app/view/".$this->config->get('config_template')."/images/print.png";
        $pledges = $this->getPledges(2,$user_id,$range,$image,$action_link);
        
        echo json_encode(array(  
            'result'=>'ok',           
            'user_id'=>$user_id,
            'user_name'=>$this->user->getUserName(),
            'nickname'=>$nickname,
            'coupons'=>$coupons,
            'pledges'=>$pledges  
            ));          
        exit;
    
    }

    function getPledges($mode,$user_id,$range,$image,$action_link) {
    
        $result = $this->model_pledges->getUserPledges($user_id);
        
        $pledges = '';
        foreach ($result as $pledg) {
            $final_price = $pledg['final_price'];
            if ($final_price == 0) continue;
            
            $status = $pledg['buy_status'];

            if (! in_array($status,$range)) continue; 
            
            $offer = sprintf("%01.2f",$final_price / 100);   
            
            $store_id = $pledg['store_id'];
            $pledge_id = $pledg['pledge_id'];
            $descriptor = $pledg['descriptor'];   
            
            $date_creation = substr($pledg['date_creation'],0,10);
            
            $date_expiration = substr($pledg['date_expiration'],0,10);
 
            $action_image = HTTP_SERVER."/app/view/".$this->config->get('config_template')."/images/$image";
 
            $action = "<a href='$action_link' ><img src='$action_image' /></a>";
            switch ($mode) {
                case 1:
                    $pledges .= "$pledge_id |$descriptor |$offer |$status | $date_creation| $date_expiration | $date_redeem | $action \n";
                    break;
                case 2: 
                    $pledges .= "$pledge_id |$descriptor |$offer |$status | $date_creation| $date_expiration | $action \n";
                    break;
                }
            
            }
            
        return $pledges;
    }
 
  
}
